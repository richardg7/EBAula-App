webpackJsonp([71],{1898:function(n,l,t){"use strict";function e(n){return a._42(0,[(n()(),a._16(0,0,null,null,19,"ion-item",[["class","item item-block"]],null,null,null,L.b,L.a)),a._15(1,1097728,null,3,E.a,[M.a,K.a,a.p,a.K,[2,N.a]],null,null),a._37(335544320,5,{contentLabel:0}),a._37(603979776,6,{_buttons:1}),a._37(603979776,7,{_icons:1}),a._15(5,16384,null,0,B.a,[],null,null),(n()(),a._40(-1,2,["\n                "])),(n()(),a._16(7,0,null,1,4,"ion-label",[["stacked",""]],null,null,null,H.b,H.a)),a._15(8,4308992,null,0,V.a,[a.p,W.a,b.a,Y.a],{coreMarkRequired:[0,"coreMarkRequired"]},null),a._15(9,16384,[[5,4]],0,j.a,[K.a,a.p,a.K,[8,null],[8,""],[8,null],[8,null]],null,null),(n()(),a._40(10,0,["",""])),a._32(131072,z.a,[W.a,a.i]),(n()(),a._40(-1,2,["\n                "])),(n()(),a._16(13,0,null,3,5,"core-rich-text-editor",[["formControlName","content"],["item-content",""],["name","content"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],null,null,Q.b,Q.a)),a._15(14,1228800,null,0,G.a,[p.a,J.a,_.a,X.a,[2,Z.a],a.p,h.a,Y.a,$.a],{placeholder:[0,"placeholder"],control:[1,"control"],name:[2,"name"],component:[3,"component"],componentId:[4,"componentId"]},null),a._32(131072,z.a,[W.a,a.i]),a._15(16,671744,null,0,c.f,[[3,c.b],[8,null],[8,null],[8,null]],{name:[0,"name"]},null),a._35(2048,null,c.m,null,[c.f]),a._15(18,16384,null,0,c.n,[c.m],null,null),(n()(),a._40(-1,2,["\n            "]))],function(n,l){var t=l.component;n(l,8,0,t.textRequired);n(l,14,0,a._41(l,14,0,a._29(l,15).transform("addon.mod_workshop.submissioncontent")),t.editForm.controls.content,"content",t.component,t.componentId);n(l,16,0,"content")},function(n,l){n(l,10,0,a._41(l,10,0,a._29(l,11).transform("addon.mod_workshop.submissioncontent")));n(l,13,0,a._29(l,18).ngClassUntouched,a._29(l,18).ngClassTouched,a._29(l,18).ngClassPristine,a._29(l,18).ngClassDirty,a._29(l,18).ngClassValid,a._29(l,18).ngClassInvalid,a._29(l,18).ngClassPending)})}function i(n){return a._42(0,[(n()(),a._16(0,0,null,null,1,"core-attachments",[["allowOffline","true"]],null,null,null,nn.b,nn.a)),a._15(1,114688,null,0,ln.a,[tn.a,p.a,b.a,g.a,W.a,en.a],{files:[0,"files"],maxSize:[1,"maxSize"],maxSubmissions:[2,"maxSubmissions"],component:[3,"component"],componentId:[4,"componentId"],allowOffline:[5,"allowOffline"],acceptedTypes:[6,"acceptedTypes"],required:[7,"required"]},null)],function(n,l){var t=l.component;n(l,1,0,t.submission.attachmentfiles,t.workshop.maxbytes,t.workshop.nattachments,t.component,t.workshop.cmid,"true",t.workshop.submissionfiletypes,t.fileRequired)},null)}function o(n){return a._42(0,[(n()(),a._16(0,0,null,null,32,"form",[["ion-list",""],["novalidate",""]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"submit"],[null,"reset"]],function(n,l,t){var e=!0;if("submit"===l){e=!1!==a._29(n,2).onSubmit(t)&&e}if("reset"===l){e=!1!==a._29(n,2).onReset()&&e}return e},null,null)),a._15(1,16384,null,0,c.w,[],null,null),a._15(2,540672,null,0,c.h,[[8,null],[8,null]],{form:[0,"form"]},null),a._35(2048,null,c.b,null,[c.h]),a._15(4,16384,null,0,c.o,[c.b],null,null),(n()(),a._40(-1,null,["\n            "])),(n()(),a._16(6,0,null,null,19,"ion-item",[["class","item item-block"],["text-wrap",""]],null,null,null,L.b,L.a)),a._15(7,1097728,null,3,E.a,[M.a,K.a,a.p,a.K,[2,N.a]],null,null),a._37(335544320,2,{contentLabel:0}),a._37(603979776,3,{_buttons:1}),a._37(603979776,4,{_icons:1}),a._15(11,16384,null,0,B.a,[],null,null),(n()(),a._40(-1,2,["\n                "])),(n()(),a._16(13,0,null,1,4,"ion-label",[["core-mark-required","true"],["stacked",""]],null,null,null,H.b,H.a)),a._15(14,4308992,null,0,V.a,[a.p,W.a,b.a,Y.a],{coreMarkRequired:[0,"coreMarkRequired"]},null),a._15(15,16384,[[2,4]],0,j.a,[K.a,a.p,a.K,[8,null],[8,""],[8,null],[8,null]],null,null),(n()(),a._40(16,0,["",""])),a._32(131072,z.a,[W.a,a.i]),(n()(),a._40(-1,2,["\n                "])),(n()(),a._16(19,0,null,3,5,"ion-input",[["formControlName","title"],["name","title"],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],null,null,on.b,on.a)),a._15(20,671744,null,0,c.f,[[3,c.b],[8,null],[8,null],[8,null]],{name:[0,"name"]},null),a._35(2048,null,c.m,null,[c.f]),a._15(22,16384,null,0,c.n,[c.m],null,null),a._15(23,5423104,null,0,sn.a,[K.a,$.a,M.a,an.a,a.p,a.K,[2,Z.a],[2,E.a],[2,c.m],un.a],{type:[0,"type"],placeholder:[1,"placeholder"]},null),a._32(131072,z.a,[W.a,a.i]),(n()(),a._40(-1,2,["\n            "])),(n()(),a._40(-1,null,["\n\n            "])),(n()(),a._11(16777216,null,null,1,null,e)),a._15(28,16384,null,0,rn.k,[a.W,a.T],{ngIf:[0,"ngIf"]},null),(n()(),a._40(-1,null,["\n\n            "])),(n()(),a._11(16777216,null,null,1,null,i)),a._15(31,16384,null,0,rn.k,[a.W,a.T],{ngIf:[0,"ngIf"]},null),(n()(),a._40(-1,null,["\n        "]))],function(n,l){var t=l.component;n(l,2,0,t.editForm);n(l,14,0,"true");n(l,20,0,"title");n(l,23,0,"text",a._41(l,23,1,a._29(l,24).transform("addon.mod_workshop.submissiontitle")));n(l,28,0,t.textAvailable);n(l,31,0,t.fileAvailable)},function(n,l){n(l,0,0,a._29(l,4).ngClassUntouched,a._29(l,4).ngClassTouched,a._29(l,4).ngClassPristine,a._29(l,4).ngClassDirty,a._29(l,4).ngClassValid,a._29(l,4).ngClassInvalid,a._29(l,4).ngClassPending);n(l,16,0,a._41(l,16,0,a._29(l,17).transform("addon.mod_workshop.submissiontitle")));n(l,19,0,a._29(l,22).ngClassUntouched,a._29(l,22).ngClassTouched,a._29(l,22).ngClassPristine,a._29(l,22).ngClassDirty,a._29(l,22).ngClassValid,a._29(l,22).ngClassInvalid,a._29(l,22).ngClassPending)})}function s(n){return a._42(0,[(n()(),a._16(0,0,null,null,23,"ion-header",[],null,null,null,null,null)),a._15(1,16384,null,0,dn.a,[K.a,a.p,a.K,[2,cn.a]],null,null),(n()(),a._40(-1,null,["\n    "])),(n()(),a._16(3,0,null,null,19,"ion-navbar",[["class","toolbar"],["core-back-button",""]],[[8,"hidden",0],[2,"statusbar-padding",null]],null,null,hn.b,hn.a)),a._15(4,49152,null,0,_n.a,[an.a,[2,cn.a],[2,mn.a],K.a,a.p,a.K],null,null),a._15(5,212992,null,0,fn.a,[_n.a,$.a,W.a,h.a],null,null),(n()(),a._40(-1,3,["\n        "])),(n()(),a._16(7,0,null,3,3,"ion-title",[],null,null,null,pn.b,pn.a)),a._15(8,49152,null,0,bn.a,[K.a,a.p,a.K,[2,gn.a],[2,_n.a]],null,null),(n()(),a._40(9,0,["",""])),a._32(131072,z.a,[W.a,a.i]),(n()(),a._40(-1,3,["\n        "])),(n()(),a._16(12,0,null,2,9,"ion-buttons",[["end",""]],null,null,null,null,null)),a._15(13,16384,null,1,vn.a,[K.a,a.p,a.K,[2,gn.a],[2,_n.a]],null,null),a._37(603979776,1,{_buttons:1}),(n()(),a._40(-1,null,["\n            "])),(n()(),a._16(16,0,null,null,4,"button",[["clear",""],["ion-button",""]],[[1,"aria-label",0]],[[null,"click"]],function(n,l,t){var e=!0;if("click"===l){e=!1!==n.component.save()&&e}return e},kn.b,kn.a)),a._15(17,1097728,[[1,4]],0,wn.a,[[8,""],K.a,a.p,a.K],{clear:[0,"clear"]},null),a._32(131072,z.a,[W.a,a.i]),(n()(),a._40(19,0,["\n                ","\n            "])),a._32(131072,z.a,[W.a,a.i]),(n()(),a._40(-1,null,["\n        "])),(n()(),a._40(-1,3,["\n    "])),(n()(),a._40(-1,null,["\n"])),(n()(),a._40(-1,null,["\n"])),(n()(),a._16(25,0,null,null,17,"ion-content",[],[[2,"statusbar-padding",null],[2,"has-refresher",null]],null,null,In.b,In.a)),a._15(26,4374528,null,0,Z.a,[K.a,$.a,un.a,a.p,a.K,an.a,Sn.a,a.D,[2,cn.a],[2,mn.a]],null,null),(n()(),a._40(-1,1,["\n    "])),(n()(),a._16(28,0,null,2,6,"ion-refresher",[],[[2,"refresher-active",null],[4,"top",null]],[[null,"ionRefresh"]],function(n,l,t){var e=!0;if("ionRefresh"===l){e=!1!==n.component.refreshSubmission(t)&&e}return e},null,null)),a._15(29,212992,null,0,yn.a,[$.a,Z.a,a.D,Dn.l],{enabled:[0,"enabled"]},{ionRefresh:"ionRefresh"}),(n()(),a._40(-1,null,["\n        "])),(n()(),a._16(31,0,null,null,2,"ion-refresher-content",[],[[1,"state",0]],null,null,Pn.b,Pn.a)),a._15(32,114688,null,0,Cn.a,[yn.a,K.a],{pullingText:[0,"pullingText"]},null),a._32(131072,z.a,[W.a,a.i]),(n()(),a._40(-1,null,["\n    "])),(n()(),a._40(-1,1,["\n    "])),(n()(),a._16(36,0,null,1,5,"core-loading",[],null,null,null,xn.b,xn.a)),a._15(37,638976,null,0,Un.a,[W.a,a.p,h.a,Y.a],{hideUntil:[0,"hideUntil"]},null),(n()(),a._40(-1,0,["\n        "])),(n()(),a._11(16777216,null,0,1,null,o)),a._15(40,16384,null,0,rn.k,[a.W,a.T],{ngIf:[0,"ngIf"]},null),(n()(),a._40(-1,0,["\n    "])),(n()(),a._40(-1,1,["\n"])),(n()(),a._40(-1,null,["\n"]))],function(n,l){var t=l.component;n(l,5,0);n(l,17,0,"");n(l,29,0,t.loaded);n(l,32,0,a._19(1,"",a._41(l,32,0,a._29(l,33).transform("core.pulltorefresh")),""));n(l,37,0,t.loaded);n(l,40,0,t.workshop)},function(n,l){n(l,3,0,a._29(l,4)._hidden,a._29(l,4)._sbPadding);n(l,9,0,a._41(l,9,0,a._29(l,10).transform("addon.mod_workshop.editsubmission")));n(l,16,0,a._41(l,16,0,a._29(l,18).transform("core.save")));n(l,19,0,a._41(l,19,0,a._29(l,20).transform("core.save")));n(l,25,0,a._29(l,26).statusbarPadding,a._29(l,26)._hasRefresher);n(l,28,0,"inactive"!==a._29(l,29).state,a._29(l,29)._top);n(l,31,0,a._29(l,32).r.state)})}Object.defineProperty(l,"__esModule",{value:!0});var a=t(1),u=(t(0),t(9),t(4)),r=t(29),d=t(30),c=t(23),h=t(13),_=t(2),m=t(86),f=t(153),p=t(5),b=t(11),g=t(67),v=t(150),k=t(173),w=t(163),I=function(){function n(n,l,t,e,i,o,s,a,u,r,d,h,_,m){this.fileUploaderProvider=t,this.workshopProvider=e,this.workshopOffline=i,this.workshopHelper=o,this.navCtrl=s,this.fileSessionprovider=a,this.syncProvider=u,this.textUtils=r,this.domUtils=d,this.fb=h,this.translate=_,this.eventsProvider=m,this.submission={id:0,title:"",content:"",attachmentfiles:[]},this.loaded=!1,this.component=v.a.COMPONENT,this.originalData={},this.hasOffline=!1,this.editing=!1,this.forceLeave=!1,this.isDestroyed=!1,this.textAvailable=!1,this.textRequired=!1,this.fileAvailable=!1,this.fileRequired=!1,this.module=n.get("module"),this.courseId=n.get("courseId"),this.access=n.get("access"),this.submissionId=n.get("submissionId"),this.workshopId=this.module.instance,this.componentId=this.module.id,this.userId=l.getCurrentSiteUserId(),this.siteId=l.getCurrentSiteId(),this.editForm=new c.g({}),this.editForm.addControl("title",this.fb.control("",c.u.required)),this.editForm.addControl("content",this.fb.control(""))}return n.prototype.ngOnInit=function(){this.isDestroyed||this.syncProvider.blockOperation(this.component,this.workshopId),this.fetchSubmissionData()},n.prototype.ionViewCanLeave=function(){var n=this;if(this.forceLeave)return!0;return(this.hasDataChanged()?this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit")):Promise.resolve()).then(function(){n.submission.attachmentfiles&&n.fileUploaderProvider.clearTmpFiles(n.submission.attachmentfiles)})},n.prototype.fetchSubmissionData=function(){var n=this;return this.workshopProvider.getWorkshop(this.courseId,this.module.id).then(function(l){if(n.workshop=l,n.textAvailable=n.workshop.submissiontypetext!=v.a.SUBMISSION_TYPE_DISABLED,n.textRequired=n.workshop.submissiontypetext==v.a.SUBMISSION_TYPE_REQUIRED,n.fileAvailable=n.workshop.submissiontypefile!=v.a.SUBMISSION_TYPE_DISABLED,n.fileRequired=n.workshop.submissiontypefile==v.a.SUBMISSION_TYPE_REQUIRED,n.editForm.controls.content.setValidators(n.textRequired?c.u.required:null),n.submissionId>0)return n.editing=!0,n.workshopHelper.getSubmissionById(n.workshopId,n.submissionId).then(function(l){n.submission=l;n.userId==l.authorid&&n.access.cansubmit&&n.access.modifyingsubmissionallowed||n.forceLeavePage()});n.access.cansubmit&&n.access.creatingsubmissionallowed||n.forceLeavePage()}).then(function(){return n.workshopOffline.getSubmissions(n.workshopId).then(function(l){if(l&&l.length){n.hasOffline=!0;var t=n.workshopHelper.filterSubmissionActions(l,n.editing?n.submission.id:0);return n.workshopHelper.applyOfflineData(n.submission,t)}n.hasOffline=!1}).finally(function(){n.originalData.title=n.submission.title,n.originalData.content=n.submission.content,n.originalData.attachmentfiles=[],n.submission.attachmentfiles.forEach(function(l){var t;t=l.filename?l.filename:"/"==l.filepath[0]?l.filepath.substr(1):l.filepath,n.originalData.attachmentfiles.push({filename:t,fileurl:l.fileurl})})})}).then(function(){n.editForm.controls.title.setValue(n.submission.title),n.editForm.controls.content.setValue(n.submission.content);n.fileSessionprovider.setFiles(n.component,n.workshopId+"_"+(n.submission.id||"newsub"),n.submission.attachmentfiles||[]),n.loaded=!0}).catch(function(l){n.loaded=!1,n.domUtils.showErrorModalDefault(l,"core.course.errorgetmodule",!0),n.forceLeavePage()})},n.prototype.forceLeavePage=function(){this.forceLeave=!0,this.navCtrl.pop()},n.prototype.getInputData=function(){var n=this.submission.id||"newsub",l={title:this.editForm.value.title,content:null,attachmentfiles:[]};return this.textAvailable&&(l.content=this.editForm.value.content||""),this.fileAvailable&&(l.attachmentfiles=this.fileSessionprovider.getFiles(this.component,this.workshopId+"_"+n)||[]),l},n.prototype.hasDataChanged=function(){if(!this.loaded)return!1;var n=this.getInputData();return!(!this.originalData||void 0===this.originalData.title)&&(!!(this.originalData.title!=n.title||this.textAvailable&&this.originalData.content!=n.content)||!!this.fileAvailable&&this.fileUploaderProvider.areFileListDifferent(n.attachmentfiles,this.originalData.attachmentfiles))},n.prototype.refreshSubmission=function(n){var l=this;if(this.loaded){var t=[];t.push(this.workshopProvider.invalidateSubmissionData(this.workshopId,this.submission.id)),t.push(this.workshopProvider.invalidateSubmissionsData(this.workshopId)),Promise.all(t).finally(function(){return l.fetchSubmissionData()}).finally(function(){n.complete()})}},n.prototype.save=function(){var n=this;this.hasDataChanged()?this.saveSubmission().then(function(){n.forceLeavePage()}).catch(function(){}):this.forceLeavePage()},n.prototype.saveSubmission=function(){var n=this,l=this.getInputData();if(!l.title)return this.domUtils.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredtitle"),Promise.reject(null);var t=this.textUtils.htmlIsBlank(l.content),e=!l.attachmentfiles.length;if(this.textRequired&&t||this.fileRequired&&e||t&&e)return this.domUtils.showAlertTranslated("core.notice","addon.mod_workshop.submissionrequiredcontent"),Promise.reject(null);var i=!0,o=!1,s=this.domUtils.showModalLoading("core.sending",!0),a=this.submission.id;return this.textAvailable&&(l.content=this.textUtils.formatHtmlLines(l.content)),i=!l.attachmentfiles.length,this.workshopHelper.uploadOrStoreSubmissionFiles(this.workshopId,this.submission.id,l.attachmentfiles,this.editing,o).catch(function(){return o=!0,i=!0,n.workshopHelper.uploadOrStoreSubmissionFiles(n.workshopId,n.submission.id,l.attachmentfiles,n.editing,o)}).then(function(t){return o||n.fileAvailable||(t=null),n.editing?o?n.workshopOffline.saveSubmission(n.workshopId,n.courseId,l.title,l.content,t,a,"update").then(function(){}):n.workshopProvider.updateSubmission(n.workshopId,a,n.courseId,l.title,l.content,t,void 0,i):o?n.workshopOffline.saveSubmission(n.workshopId,n.courseId,l.title,l.content,t,a,"add").then(function(){}):n.workshopProvider.addSubmission(n.workshopId,n.courseId,l.title,l.content,t,void 0,a,i)}).then(function(t){var e={workshopId:n.workshopId,cmId:n.module.cmid};t&&a&&(n.workshopOffline.deleteSubmissionAction(n.workshopId,a,n.editing?"update":"add"),n.workshopHelper.deleteSubmissionStoredFiles(n.workshopId,a,n.editing),e.submissionId=t);return(t?n.workshopProvider.invalidateSubmissionData(n.workshopId,t):Promise.resolve()).finally(function(){n.eventsProvider.trigger(v.a.SUBMISSION_CHANGED,e,n.siteId),n.fileUploaderProvider.clearTmpFiles(l.attachmentfiles)})}).catch(function(l){n.domUtils.showErrorModalDefault(l,"Cannot save submission")}).finally(function(){s.dismiss()})},n.prototype.ngOnDestroy=function(){this.isDestroyed=!0,this.syncProvider.unblockOperation(this.component,this.workshopId)},n}(),S=function(){return function(){}}(),y=t(1345),D=t(1346),P=t(1347),C=t(1348),x=t(1349),U=t(1350),O=t(1351),R=t(1352),q=t(1353),A=t(1356),F=t(1357),T=t(1358),L=t(31),E=t(21),M=t(20),K=t(7),N=t(28),B=t(33),H=t(83),V=t(76),W=t(19),Y=t(3),j=t(62),z=t(27),Q=t(277),G=t(227),J=t(26),X=t(17),Z=t(24),$=t(15),nn=t(447),ln=t(280),tn=t(10),en=t(133),on=t(94),sn=t(79),an=t(34),un=t(32),rn=t(8),dn=t(435),cn=t(37),hn=t(1354),_n=t(200),mn=t(22),fn=t(663),pn=t(1355),bn=t(337),gn=t(247),vn=t(436),kn=t(46),wn=t(43),In=t(185),Sn=t(107),yn=t(145),Dn=t(39),Pn=t(201),Cn=t(159),xn=t(49),Un=t(48),On=t(61),Rn=a._14({encapsulation:2,styles:[],data:{}}),qn=a._12("page-addon-mod-workshop-edit-submission",I,function(n){return a._42(0,[(n()(),a._16(0,0,null,null,1,"page-addon-mod-workshop-edit-submission",[],null,null,null,s,Rn)),a._15(1,245760,null,0,I,[On.a,_.a,g.a,v.a,w.a,k.a,mn.a,f.a,m.a,b.a,p.a,c.d,W.a,h.a],null,null)],function(n,l){n(l,1,0)},null)},{},{},[]),An=t(333),Fn=t(334),Tn=t(336),Ln=t(335),En=t(434),Mn=t(662),Kn=t(106),Nn=t(248);t.d(l,"AddonModWorkshopEditSubmissionPageModuleNgFactory",function(){return Bn});var Bn=a._13(S,[],function(n){return a._25([a._26(512,a.n,a._6,[[8,[y.a,D.a,P.a,C.a,x.a,U.a,O.a,R.a,q.a,A.a,F.a,T.a,qn]],[3,a.n],a.B]),a._26(4608,rn.m,rn.l,[a.x,[2,rn.v]]),a._26(4608,c.x,c.x,[]),a._26(4608,c.d,c.d,[]),a._26(4608,An.b,An.a,[]),a._26(4608,Fn.a,Fn.b,[]),a._26(4608,Tn.b,Tn.a,[]),a._26(4608,Ln.b,Ln.a,[]),a._26(4608,W.a,W.a,[En.a,An.b,Fn.a,Tn.b,Ln.b,W.b,W.c]),a._26(512,d.a,d.a,[]),a._26(512,rn.b,rn.b,[]),a._26(512,c.v,c.v,[]),a._26(512,c.i,c.i,[]),a._26(512,c.s,c.s,[]),a._26(512,Mn.a,Mn.a,[]),a._26(512,u.a,u.a,[]),a._26(512,Kn.a,Kn.a,[]),a._26(512,r.a,r.a,[]),a._26(512,Mn.b,Mn.b,[]),a._26(512,S,S,[]),a._26(256,W.c,void 0,[]),a._26(256,W.b,void 0,[]),a._26(256,Nn.a,I,[])])})}});